<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeu Puzzle Vital Sport</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* Styles de base pour toutes les pages */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Inter', sans-serif;
            color: white;
            /* Fond avec dégradé animé */
            background: linear-gradient(-45deg, #00a99d, #007a73, #00a99d, #007a73);
            background-size: 400% 400%;
            animation: gradient-animation 15s ease infinite;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Empêche le défilement */
        }

        /* Définition de l'animation pour le dégradé */
        @keyframes gradient-animation {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }


        /* En-tête de page secondaire */
        .page-header {
            width: 100%;
            display: flex;
            justify-content: space-between; /* Permet de placer les éléments aux extrémités */
            align-items: center; /* Centre les éléments verticalement */
            padding: 1.5vh 4vw;
            box-sizing: border-box;
            flex-shrink: 0;
        }
        .page-header .back-button {
            font-size: 3.5vh;
            color: white;
            text-decoration: none;
            transition: transform 0.2s ease;
        }
        .page-header .back-button:hover {
            transform: scale(1.1);
        }
        /* Style du logo Vital Sport (agrandi) */
        .page-header .logo {
            max-height: 8vh; /* Taille maximale du logo, ajustée pour la hauteur */
            max-width: 30vw; /* Empêche le logo d'être trop grand sur les grands écrans */
        }

        /* Conteneur principal du contenu du jeu, centré */
        .game-content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            padding: 0.5vh;
            box-sizing: border-box;
            overflow: hidden;
            /* Ajustement pour remonter le contenu */
            margin-top: -5vh; 
        }

        /* Titre du jeu */
        .main-title {
            font-size: 5vh;
            font-weight: 900;
            text-align: center;
            margin: 0 0 0.5vh;
            /* Animation de battement de cœur */
            animation: pulse-heartbeat 2s infinite ease-in-out;
        }
        /* Définition des keyframes pour l'animation */
        @keyframes pulse-heartbeat {
            0% { transform: scale(1); }
            20% { transform: scale(1.05); }
            50% { transform: scale(1); }
            80% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }


        /* Texte d'introduction du jeu */
        .intro-text {
            font-size: 2.2vh;
            font-weight: 400;
            text-align: center;
            margin-bottom: 1vh;
            max-width: 90%;
            color: white;
        }
        

        /* Minuteur */
        .timer {
            font-size: 3.5vh;
            font-weight: 700;
            margin-bottom: 1.5vh;
        }

        /* Conteneur de puzzle */
        .puzzle-container {
            position: relative;
            background-color: #e3f2fd;
            border-radius: 10px;
            padding: 3px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 2px;
            width: 85vmin;
            height: calc(85vmin * 4 / 5);
            max-height: 60vh;
        }

        /* Pièce de puzzle */
        .puzzle-piece {
            border: 1px solid rgba(0,0,0,0.1);
            background-size: 500% 400%;
            cursor: pointer;
            transition: transform 0.1s ease;
        }

        /* Conteneur d'image */
        .image-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 10px;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            display: none;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        /* Overlay de victoire */
        .win-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        .win-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        .win-overlay h2 {
            font-size: 4vh;
            font-weight: 900;
            margin: 0;
            color: white;
            animation: bounceIn 1s ease-in-out;
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            80% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        /* Styles pour le tableau de bord du jeu */
        .game-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin-top: 1.5vh;
            gap: 1.5vh;
            flex-shrink: 0;
        }
        .control-buttons button {
            background-color: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 6vh;
            height: 6vh;
            font-size: 3vh;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }
        .control-buttons button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0,0,0,0.15);
        }
        
        /* Pied de page */
        .kiosk-footer {
            padding: 1vh;
            background-color: rgba(0, 0, 0, 0.1);
            text-align: center;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5vh;
        }
        .kiosk-footer .footer-text {
            font-size: 1.4vh;
            margin: 0;
        }
        .kiosk-footer .legal-link {
            font-size: 1.4vh;
            color: white;
            text-decoration: underline;
            cursor: pointer;
            margin-top: 0.5vh;
        }

        /* Modal pour les mentions légales et le puzzle */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            padding: 2vh;
            box-sizing: border-box;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: #fefefe;
            color: #333;
            padding: 3vh 3vw;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            text-align: center; /* Aligne le contenu du modal au centre */
        }
        .modal-close-button {
            position: absolute;
            top: 1.5vh;
            right: 1.5vw;
            color: #aaa;
            font-size: 4vh;
            font-weight: bold;
            cursor: pointer;
            z-index: 104; /* Assure que le bouton de fermeture est toujours visible */
        }
        .modal-close-button:hover,
        .modal-close-button:focus {
            color: #000;
            text-decoration: none;
        }
        .modal-content h2 {
            font-size: 3vh;
            font-weight: 700;
            margin-top: 0;
        }
        .modal-content h3 {
            font-size: 2.5vh;
            font-weight: 700;
            margin-top: 2vh;
            margin-bottom: 1vh;
        }
        .modal-content p {
            font-size: 1.8vh;
            line-height: 1.5;
            margin-bottom: 1.5vh;
        }
        .modal-content .editor-logo,
        .modal-content .partners-logo {
            display: block; /* Important pour que margin:auto fonctionne */
            margin-left: auto;
            margin-right: auto;
        }
        .modal-content .editor-logo {
            max-height: 5vh;
            margin-bottom: 1vh;
        }
        .modal-content .partners-logo {
            max-width: 100%;
            height: auto;
            margin-top: 1vh;
        }

        /* Styles spécifiques pour le modal du puzzle */
        #puzzle-details-modal .modal-content {
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 1.5vh;
            position: relative;
            z-index: 102;
        }
        #puzzle-details-modal .modal-content h2 {
            text-align: center;
            font-size: 3.5vh;
            margin-bottom: 1vh;
            color: #007a73;
        }
        #puzzle-details-modal .modal-content h3 {
            text-align: center;
            font-size: 2.5vh;
            margin-bottom: 1vh;
            color: #333;
        }
        #puzzle-details-modal .modal-content p {
            font-size: 2vh;
            line-height: 1.6;
        }
        #modal-puzzle-image {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            margin: 1vh auto;
            display: block;
        }
        /* Mise à jour pour un meilleur espacement et alignement */
        .puzzle-info-card {
            display: flex;
            flex-direction: row; 
            gap: 2vw; /* Espacement entre le texte et le QR code */
            align-items: center; /* Aligne verticalement au centre */
            background-color: #f0f0f0;
            padding: 1.5vh 2.5vw;
            border-radius: 10px;
        }
        .puzzle-info-card .info-details {
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            gap: 1.5vh; /* Espacement entre les éléments d'info (adresse, tel, etc.) */
        }
        .puzzle-info-item {
            display: flex;
            align-items: flex-start;
            gap: 1.5vw;
        }
        
        .item-icon {
            font-size: 2.5vh;
            color: #00a99d;
            flex-shrink: 0;
        }

        .item-text {
            text-align: left;
            font-size: 1.8vh;
            line-height: 1.4;
        }
        
        /* Styles pour l'animation des confettis */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 101; /* Pour être au-dessus du modal */
            pointer-events: none; /* Permet les clics à travers le canvas */
        }
        
        /* Animation du texte "Félicitations !" au-dessus du modal */
        #congrats-text {
            position: absolute;
            top: 10%; 
            left: 50%;
            transform: translateX(-50%) scale(0);
            font-size: 6vh;
            font-weight: 900;
            color: #ffeb3b; 
            text-shadow: 0 0 10px #ffc107, 0 0 20px #ff9800;
            z-index: 103;
            opacity: 0;
            display: none;
        }

        #puzzle-details-modal.show #congrats-text {
            display: block;
            animation: text-implosion 2s infinite ease-in-out;
        }

        @keyframes text-implosion {
            0% {
                transform: translateX(-50%) scale(0);
                opacity: 0;
            }
            50% {
                transform: translateX(-50%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translateX(-50%) scale(1);
                opacity: 1;
            }
        }
        
        /* Styles pour le conteneur du QR Code */
        .qrcode-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1vh;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            background-color: #fefefe;
            flex-shrink: 0; /* Empêche le QR code de se réduire */
            text-align: center;
        }
        .qrcode-container p {
            font-size: 2vh;
            font-weight: 700;
            color: #007a73;
            margin: 0;
        }
        #qrcode-canvas {
            width: 100%;
            height: auto;
            max-width: 150px;
        }
        
        /* Media queries pour rendre le modal plus responsive sur les petits écrans */
        @media (max-width: 768px) {
            #puzzle-details-modal .modal-content {
                padding: 2vh 4vw;
                max-width: 95%;
            }
            #puzzle-details-modal .modal-content h2,
            #puzzle-details-modal .modal-content h3 {
                font-size: 2.5vh;
            }
            #puzzle-details-modal .modal-content p {
                font-size: 1.6vh;
            }
            #congrats-text {
                font-size: 4vh;
                top: 5%;
            }
            .puzzle-info-card {
                flex-direction: column;
                align-items: center;
                gap: 1.5vh;
                padding: 1.5vh;
            }
            .puzzle-info-item {
                flex-direction: row; /* Garde les icônes et le texte côte à côte */
                align-items: flex-start;
                gap: 1vw;
            }
            .item-text {
                text-align: left;
            }
            .modal-close-button {
                font-size: 3vh;
            }
            #qrcode-canvas {
                max-width: 120px;
            }
        }
    </style>
</head>
<body>

    <header class="page-header">
        <a href="index.html" class="back-button">
            <i class="fas fa-arrow-left"></i>
        </a>
        <img src="logo_vital_sport_-removebg-preview.png" alt="Logo Vital Sport" class="logo">
    </header>

    <main class="game-content-wrapper">
        <h1 class="main-title">Jeu de Puzzle</h1>
        <p class="intro-text">Reconstituez l'image en glissant et déposant les pièces et découvrez l'activité. Bonne chance !</p>

        <span class="timer" id="timer">00:00</span>
        
        <div class="puzzle-container" id="puzzle-container">
            <div class="image-container" id="image-view"></div>
            <div class="win-overlay" id="win-overlay">
                <h2>Félicitations !</h2>
            </div>
        </div>

        <!-- Tableau de bord du jeu -->
        <div class="game-controls">
            <div class="control-buttons">
                <button id="new-puzzle-button" title="Nouveau puzzle"><i class="fas fa-redo-alt"></i></button>
                <button id="view-image-button" title="Afficher l'image"><i class="fas fa-eye"></i></button>
            </div>
        </div>
    </main>
    
    <!-- ===== PIED DE PAGE ===== -->
    <footer class="kiosk-footer">
        <p class="footer-text">&copy; 2025 Destination Sud Réunion</p>
        <a href="#" class="legal-link" id="show-legal-modal">Mentions légales</a>
    </footer>

    <!-- ===== MODAL MENTIONS LÉGALES ===== -->
    <div id="legal-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button" id="close-legal-modal">&times;</span>
            <h2>Mentions Légales</h2>
            <h3>Éditeur du site</h3>
            <img src="https://srias.re/wp-content/uploads/2020/12/Destination-Sud-Reunion-png-1-min.png" alt="Logo Destination Sud Réunion" class="editor-logo">
            <p><strong>Éditeur du site :</strong> Destination Sud Réunion</p>
            <p><strong>Adresse :</strong> Capitainerie du Port de Plaisance Lislet Geoffroy - place Napoléon Hoareau, 97410 Saint-Pierre</p>
            <p><strong>Contact :</strong><br>Téléphone : 0262353433<br>Email : saintpierre.tourisme@gmail.com</p>
            <p><strong>Hébergement :</strong><br>Google Cloud Platform</p>
            <p><strong>Propriété intellectuelle :</strong><br>Le contenu de ce site (textes, images, etc.) est la propriété exclusive de Decathlon Réunion, sauf mention contraire. Toute reproduction ou utilisation, même partielle, est interdite sans autorisation préalable.</p>
            <p><strong>Protection des données personnelles :</strong><br>Ce site ne collecte aucune donnée personnelle. Le jeu est conçu pour être anonyme et ne stocke aucune information sur les joueurs.</p>
            <h3>Partenaires</h3>
            <img src="logo_partenaires-removebg-preview.png" alt="Logos partenaires" class="partners-logo">
            <p><strong>Crédits photos :</strong><br>Les images utilisées dans ce jeu proviennent de partenaires Decathlon et de Crazy Adventures Réunion.</p>
        </div>
    </div>
    
    <!-- Canvas pour l'animation de confettis -->
    <canvas id="confetti-canvas"></canvas>

    <!-- ===== MODAL DÉTAILS DU PUZZLE ===== -->
    <div id="puzzle-details-modal" class="modal">
        <h2 id="congrats-text">Félicitations !</h2>
        <div class="modal-content">
            <span class="modal-close-button" id="close-puzzle-modal">&times;</span>
            <img id="modal-puzzle-image" src="" alt="Image du puzzle résolu">
            <h2 id="modal-puzzle-title"></h2>
            <p id="modal-puzzle-description"></p>
            <div id="modal-puzzle-details"></div>
        </div>
    </div>

    <!-- Script de la librairie QR Code -->
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <script>
        const puzzleData = [
            {
                id: 1,
                image: "https://placehold.co/800x600/8dc63f/ffffff?text=Football",
                title: "Terrain de Football",
                description: "Un terrain de football Decathlon prêt pour un match."
            },
            {
                id: 2,
                image: "https://placehold.co/800x600/0072c6/ffffff?text=Basketball",
                title: "Match de Basketball",
                description: "Un ballon de basket en action sur le terrain."
            },
            {
                id: 3,
                image: "https://placehold.co/800x600/f58220/ffffff?text=Cyclisme",
                title: "Course de Cyclisme",
                description: "Un cycliste en pleine course, poussé par la foule."
            },
            {
                id: 4,
                image: "https://www.crazy-adventures.fr/ressources/images/f511fa13f9bd.jpg",
                title: "CRAZY ADVENTURES Réunion",
                description: "Spécialiste de la location de véhicule tout terrain en toute sécurité. Vivez votre crazy adventure !",
                address: "67 Chemin Vetyver<br>97410 SAINT-PIERRE",
                hours: "Du Lundi au Dimanche<br>08h - 16h",
                phone: "09 74 56 75 07",
                qrcodeLink: "https://www.crazy-adventures.fr"
            },
            {
                id: 5,
                image: "https://placehold.co/800x600/e94d8b/ffffff?text=Natation",
                title: "Piscine Olympique",
                description: "Un nageur s'entrainant dans la piscine."
            },
            {
                id: 6,
                image: "https://placehold.co/800x600/9b59b6/ffffff?text=Tennis",
                title: "Terrain de Tennis",
                description: "Échange de balles sur un court de tennis."
            },
            {
                id: 7,
                image: "https://placehold.co/800x600/3498db/ffffff?text=Boxe",
                title: "Boxe sur le ring",
                description: "Deux boxeurs s'affrontant sur le ring."
            },
            {
                id: 8,
                image: "https://placehold.co/800x600/f1c40f/ffffff?text=Course",
                title: "Course à pied",
                description: "Un coureur en pleine performance."
            },
            {
                id: 9,
                image: "https://placehold.co/800x600/e67e22/ffffff?text=Fitness",
                title: "Salle de Fitness",
                description: "Un entrainement de fitness en groupe."
            },
            {
                id: 10,
                image: "https://placehold.co/800x600/1abc9c/ffffff?text=Ski",
                title: "Ski en montagne",
                description: "Un skieur dévalant une piste enneigée."
            },
            {
                id: 11,
                image: "https://placehold.co/800x600/34495e/ffffff?text=Handball",
                title: "Match de Handball",
                description: "L'équipe de handball en plein match."
            },
            {
                id: 12,
                image: "https://placehold.co/800x600/e74c3c/ffffff?text=Volley",
                title: "Volley-ball sur la plage",
                description: "Un match de volley-ball sur la plage."
            },
            {
                id: 13,
                image: "https://placehold.co/800x600/2980b9/ffffff?text=Rugby",
                title: "Match de Rugby",
                description: "Un joueur de rugby portant le ballon."
            },
            {
                id: 14,
                image: "https://placehold.co/800x600/95a5a6/ffffff?text=Escalade",
                title: "Mur d'escalade",
                description: "Un grimpeur en pleine ascension."
            },
            {
                id: 15,
                image: "https://placehold.co/800x600/2c3e50/ffffff?text=Judo",
                title: "Entrainement de Judo",
                description: "Deux judokas s'affrontant en judo."
            },
            {
                id: 16,
                image: "https://www.espacemer.re/wp-content/uploads/2019/04/canstockphoto50459579-1024x683.jpg",
                title: "Espace Mer",
                description: "Spécialiste de la location de jetski. Partez à l'aventure en mer !",
                address: "Port de Saint pierre<br>97410 Saint-Pierre",
                hours: "Du Lundi au Samedi<br>10H00 – 12H00<br>14H00 – 17H00",
                phone: "06 92 614 360",
                qrcodeLink: "https://www.espacemer.re/"
            },
            {
                id: 17,
                image: "https://static.wixstatic.com/media/7983d0_56027957a7844a998a6b0667901f39c3~mv2.jpg/v1/fill/w_438,h_293,fp_0.50_0.50,q_80,usm_0.66_1.00_0.01,enc_auto/7983d0_56027957a7844a998a6b0667901f39c3~mv2.jpg",
                title: "REUNION MOUNTAIN BIKE",
                description: "Découvrez Réunion Mountain Bike, votre spécialiste local pour des aventures à vélo inoubliables à La Réunion.",
                address: "Rue Guy Hoarau, Étang-salée<br>97427",
                hours: "Lundi : sur RDV<br>Mardi : sur RDV<br>Mercredi : 8h - 18h<br>Jeudi : sur RDV<br>Vendredi : 8h - 18h<br>Samedi et Dimanche : 8h - 18h",
                phone: "0693 214 500",
                email: "reunionmountainbike@gmail.com",
                qrcodeLink: "https://www.reunionmountainbike.com/"
            },
            {
                id: 18,
                image: "https://elliptigo-reunion.com/wp-content/uploads/2023/05/BFY_7852-copie.jpg",
                title: "ELLIPTIGO REUNION",
                description: "L’ElliptiGO, location de vélo elliptique à la Réunion. Votre connexion-glisse vous accompagne dans votre quête de loisirs ludiques, sportive et écologique.",
                address: "Départ Etang-Salé les Bains ou dans la forêt",
                phone: "0692 003 524",
                email: "contact@elliptigo-reunion.com",
                qrcodeLink: "https://elliptigo-reunion.com/"
            }
        ];

        const COLS = 5;
        const ROWS = 4;
        const totalPieces = COLS * ROWS;
        let currentPuzzle = null;
        let pieces = [];
        let isStarted = false;
        let timerInterval = null;
        let seconds = 0;
        let isSolved = false;
        let confettiAnimation = null; // Gère l'état de l'animation de confettis

        const puzzleContainer = document.getElementById('puzzle-container');
        const imageView = document.getElementById('image-view');
        const timerDisplay = document.getElementById('timer');
        const viewImageButton = document.getElementById('view-image-button');
        const newPuzzleButton = document.getElementById('new-puzzle-button');
        const winOverlay = document.getElementById('win-overlay');
        
        // Modal Mentions Légales
        const showLegalModalButton = document.getElementById('show-legal-modal');
        const legalModal = document.getElementById('legal-modal');
        const closeLegalModalButton = document.getElementById('close-legal-modal');

        // Modal Détails du Puzzle
        const puzzleDetailsModal = document.getElementById('puzzle-details-modal');
        const closePuzzleModalButton = document.getElementById('close-puzzle-modal');
        const modalPuzzleImage = document.getElementById('modal-puzzle-image');
        const modalPuzzleTitle = document.getElementById('modal-puzzle-title');
        const modalPuzzleDescription = document.getElementById('modal-puzzle-description');
        const modalPuzzleDetails = document.getElementById('modal-puzzle-details');
        const congratsText = document.getElementById('congrats-text');

        // Confetti Canvas
        const confettiCanvas = document.getElementById('confetti-canvas');
        const ctx = confettiCanvas.getContext('2d');
        let confettiParticles = [];
        const confettiColors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800', '#ff5722', '#795548', '#9e9e9e', '#607d8b'];
        
        // Fonction pour un nombre aléatoire dans une plage
        function randomRange(min, max) {
            return Math.random() * (max - min) + min;
        }

        // Classe pour les particules de confettis
        class Confetti {
            constructor() {
                this.x = randomRange(0, confettiCanvas.width);
                this.y = -10;
                this.size = randomRange(5, 10);
                this.color = confettiColors[Math.floor(randomRange(0, confettiColors.length))];
                this.velocity = {
                    x: randomRange(-2, 2),
                    y: randomRange(2, 5)
                };
                this.rotation = randomRange(0, 360);
                this.rotationSpeed = randomRange(1, 5);
                this.opacity = 1;
            }

            update() {
                this.x += this.velocity.x;
                this.y += this.velocity.y;
                this.velocity.y += 0.05; // Gravité
                this.rotation += this.rotationSpeed;
                this.opacity -= 0.005;
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation * Math.PI / 180);
                ctx.globalAlpha = this.opacity;
                ctx.fillStyle = this.color;
                ctx.fillRect(-this.size / 2, -this.size / 2, this.size, this.size);
                ctx.restore();
            }
        }
        
        // Fonction pour démarrer l'animation de confettis
        function startConfetti() {
            confettiCanvas.width = window.innerWidth;
            confettiCanvas.height = window.innerHeight;
            
            function animateConfetti() {
                // Créer de nouvelles particules
                if (Math.random() > 0.8) {
                    confettiParticles.push(new Confetti());
                }

                ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
                
                // Mettre à jour et dessiner les particules existantes
                for (let i = confettiParticles.length - 1; i >= 0; i--) {
                    confettiParticles[i].update();
                    confettiParticles[i].draw();

                    if (confettiParticles[i].y > confettiCanvas.height || confettiParticles[i].opacity <= 0) {
                        confettiParticles.splice(i, 1);
                    }
                }
                
                confettiAnimation = requestAnimationFrame(animateConfetti);
            }
            animateConfetti();
        }

        // Fonction pour arrêter l'animation de confettis
        function stopConfetti() {
            cancelAnimationFrame(confettiAnimation);
            confettiParticles = [];
            ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
        }


        // Fonction pour sélectionner un puzzle aléatoire
        function getRandomPuzzle() {
            const randomIndex = Math.floor(Math.random() * puzzleData.length);
            return puzzleData[randomIndex];
        }

        // Fonction pour initialiser le puzzle
        function initPuzzle() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            stopConfetti(); // Arrête les confettis au démarrage d'un nouveau puzzle
            isStarted = false;
            seconds = 0;
            isSolved = false;
            winOverlay.classList.remove('show');
            puzzleDetailsModal.style.display = 'none'; // Cache la modale si elle était ouverte
            puzzleDetailsModal.classList.remove('show'); // Retire la classe pour l'animation du texte
            timerDisplay.textContent = '00:00';
            
            // Choix aléatoire d'un nouveau puzzle
            currentPuzzle = getRandomPuzzle();
            imageView.style.backgroundImage = `url(${currentPuzzle.image})`;


            // Nettoyage de l'ancien puzzle
            puzzleContainer.innerHTML = '';
            puzzleContainer.appendChild(imageView);
            puzzleContainer.appendChild(winOverlay);
            pieces = [];

            // Création des pièces
            for (let i = 0; i < totalPieces; i++) {
                const piece = document.createElement('div');
                piece.classList.add('puzzle-piece');
                piece.style.backgroundImage = `url(${currentPuzzle.image})`;

                const row = Math.floor(i / COLS);
                const col = i % COLS;

                const bgX = (col / (COLS - 1)) * 100;
                const bgY = (row / (ROWS - 1)) * 100;

                piece.style.backgroundPosition = `${bgX}% ${bgY}%`;
                piece.dataset.index = i;
                
                pieces.push(piece);
            }

            shufflePieces();
            pieces.forEach(piece => puzzleContainer.appendChild(piece));

            // Ajout des événements de drag and drop
            pieces.forEach(piece => {
                piece.draggable = true;
                piece.addEventListener('dragstart', handleDragStart);
                piece.addEventListener('dragover', handleDragOver);
                piece.addEventListener('drop', handleDrop);
                piece.addEventListener('dragenter', handleDragEnter);
                piece.addEventListener('dragleave', handleDragLeave);
            });
        }

        // Mélange les pièces
        function shufflePieces() {
            for (let i = pieces.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                const tempPiece = pieces[i];
                pieces[i] = pieces[j];
                pieces[j] = tempPiece;
            }
        }

        // Drag and Drop
        let draggedPiece = null;

        function handleDragStart(e) {
            draggedPiece = e.target;
            // Démarre le timer si ce n'est pas déjà fait
            if (!isStarted) {
                startTimer();
                isStarted = true;
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDragEnter(e) {
            e.preventDefault();
            e.target.style.opacity = 0.5;
        }
        
        function handleDragLeave(e) {
            e.target.style.opacity = 1;
        }

        function handleDrop(e) {
            e.preventDefault();
            const dropTarget = e.target;

            if (dropTarget.classList.contains('puzzle-piece')) {
                dropTarget.style.opacity = 1;
            }
            
            if (draggedPiece && draggedPiece !== dropTarget && dropTarget.classList.contains('puzzle-piece')) {
                const tempParent = puzzleContainer;
                const tempNextSibling = draggedPiece.nextSibling === dropTarget ? draggedPiece : draggedPiece.nextSibling;

                const dropTargetNextSibling = dropTarget.nextSibling;
                
                tempParent.insertBefore(draggedPiece, dropTargetNextSibling);
                tempParent.insertBefore(dropTarget, tempNextSibling);
                
                checkWin();
            }
        }
        
        // Vérification de la victoire
        function checkWin() {
            let isCorrect = true;
            const currentPieces = Array.from(puzzleContainer.querySelectorAll('.puzzle-piece'));

            for (let i = 0; i < currentPieces.length; i++) {
                if (parseInt(currentPieces[i].dataset.index) !== i) {
                    isCorrect = false;
                    break;
                }
            }

            if (isCorrect && !isSolved) {
                isSolved = true;
                if (timerInterval) {
                    clearInterval(timerInterval);
                }
                setTimeout(() => {
                    winOverlay.classList.add('show');
                    showPuzzleDetailsModal(currentPuzzle); // Affiche la nouvelle modal
                    startConfetti(); // Lance l'animation de confettis
                }, 500);
            }
        }

        // Affiche la modale avec les détails du puzzle
        function showPuzzleDetailsModal(puzzle) {
            modalPuzzleImage.src = puzzle.image;
            modalPuzzleTitle.textContent = puzzle.title;
            modalPuzzleDescription.textContent = puzzle.description;
            
            // Nettoyer l'ancien contenu des détails
            modalPuzzleDetails.innerHTML = '';
            
            // Construire les détails (adresse, horaires, etc.)
            let detailsHtml = '';
            
            if (puzzle.address || puzzle.hours || puzzle.phone || puzzle.email) {
                detailsHtml += '<div class="puzzle-info-card">';
                detailsHtml += '<div class="info-details">';

                if (puzzle.address) {
                    detailsHtml += `
                        <div class="puzzle-info-item">
                            <i class="fas fa-map-marker-alt item-icon"></i>
                            <span class="item-text">${puzzle.address}</span>
                        </div>
                    `;
                }
                if (puzzle.hours) {
                    detailsHtml += `
                        <div class="puzzle-info-item">
                            <i class="fas fa-clock item-icon"></i>
                            <span class="item-text">${puzzle.hours}</span>
                        </div>
                    `;
                }
                if (puzzle.phone) {
                    detailsHtml += `
                        <div class="puzzle-info-item">
                            <i class="fas fa-phone item-icon"></i>
                            <span class="item-text">${puzzle.phone}</span>
                        </div>
                    `;
                }
                if (puzzle.email) {
                    detailsHtml += `
                        <div class="puzzle-info-item">
                            <i class="fas fa-envelope item-icon"></i>
                            <span class="item-text">${puzzle.email}</span>
                        </div>
                    `;
                }

                detailsHtml += '</div>';

                // Générer le QR code si le lien existe et l'ajouter à la carte
                if (puzzle.qrcodeLink) {
                    detailsHtml += `<div class="qrcode-container"><p>Scannez pour plus d'infos :</p><div id="qrcode-canvas"></div></div>`;
                }
                detailsHtml += '</div>';
            }

            modalPuzzleDetails.innerHTML = detailsHtml;

            // Générer le QR code si le lien existe
            if (puzzle.qrcodeLink) {
                // S'assurer que le div pour le QR code est dans le DOM avant de le générer
                setTimeout(() => {
                    new QRCode(document.getElementById("qrcode-canvas"), {
                        text: puzzle.qrcodeLink,
                        width: 128,
                        height: 128,
                        colorDark : "#000000",
                        // L'arrière-plan devient transparent en utilisant la couleur "transparent"
                        colorLight : "transparent",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                }, 50); // Petit délai pour s'assurer que l'élément est rendu
            }
            
            puzzleDetailsModal.style.display = 'flex';
            puzzleDetailsModal.classList.add('show');
        }
        
        // Fonctionnalité du timer
        function startTimer() {
            timerInterval = setInterval(() => {
                seconds++;
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                timerDisplay.textContent = `${minutes < 10 ? '0' : ''}${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
            }, 1000);
        }

        // Bouton pour changer de puzzle
        newPuzzleButton.addEventListener('click', () => {
            initPuzzle();
        });

        // Bouton pour voir l'image
        let isImageViewVisible = false;
        viewImageButton.addEventListener('click', () => {
            isImageViewVisible = !isImageViewVisible;
            if (isImageViewVisible) {
                imageView.style.display = 'block';
                viewImageButton.innerHTML = `<i class="fas fa-eye-slash"></i>`;
            } else {
                imageView.style.display = 'none';
                viewImageButton.innerHTML = `<i class="fas fa-eye"></i>`;
            }
        });

        // Gestion de la modal des mentions légales
        showLegalModalButton.addEventListener('click', (e) => {
            e.preventDefault();
            legalModal.style.display = 'flex';
        });

        closeLegalModalButton.addEventListener('click', () => {
            legalModal.style.display = 'none';
        });
        
        // Gestion de la modal du puzzle
        closePuzzleModalButton.addEventListener('click', () => {
            puzzleDetailsModal.style.display = 'none';
            puzzleDetailsModal.classList.remove('show');
            stopConfetti(); // Arrête les confettis à la fermeture du modal
        });

        window.addEventListener('click', (e) => {
            if (e.target === legalModal) {
                legalModal.style.display = 'none';
            }
            if (e.target === puzzleDetailsModal) {
                puzzleDetailsModal.style.display = 'none';
                puzzleDetailsModal.classList.remove('show');
                stopConfetti(); // Arrête les confettis si on clique à côté du modal
            }
        });

        // Fonction pour gérer la redimension de la fenêtre et ajuster le canvas
        window.addEventListener('resize', () => {
            if (confettiAnimation) {
                confettiCanvas.width = window.innerWidth;
                confettiCanvas.height = window.innerHeight;
            }
        });


        // Initialisation au chargement de la page
        window.onload = initPuzzle;

    </script>
</body>
</html>
